###Step 0###
cmsrel CMSSW_5_2_5
cd CMSSW_5_2_5/src
cmsenv
cvs co HiggsAnalysis/CombinedLimit
scram b -j4
cd ../..
cp -r HCG CMSSW_5_2_5/src
cp -r RunLimits/scripts/* CMSSW_5_2_4/src/HCG
cd CMSSW_5_2_5/src/HCG
mkdir results
mkdir plots 

###Step1###
#Make combined cards

for M in $(cat masses.txt); do bash make_combined_cards_hzz4l.sh $M $sqrts; done



###Step2###
#Make binary workspaces

--->for M in $(cat masses.txt); do bash make_binary_workspaces_hzz4l.sh $M comb_hzz4l.txt; done
*** for M in $(cat masses.txt); do bash make_binary_workspaces_hzz4l.sh $M SM4_comb_hzz4l.txt; done
to do SM4

############################# The Good Stuff ##################################

################ Running Profile Likelihood##################
For the PL we used the following non-default options: --optimizeSim=1 (speeds up calculation of likelihoods for complex models) and --useMinos (bypass ProfileLikelihoodCalculator and use directly MINOS, since in ROOT 5.28 it's more robust)

To produce approximate limits using PL asymptotics 

---> for M in $(cat masses.txt); do bash make_PLC_hzz4l.sh $M comb_hzz4l.root; done

This will create in each mass directory a root file with the limit and a log file called e.g. comb.log.PLC. You can find below how to harvest these files 
and make plots

If you get bad fits for some masses, you can repeat the limit in a more robust way repeating the fit multiple times (but it's much slower, so you probably
don't want to do it for all masses)

--->for M in ...; do bash make_PLC_hzz4l.sh -s $M comb_hzz4l.root; done

To produce _p_-value scans 

--->for M in $(cat masses.txt); do bash make_PLC.sh -P $M comb_hzz4l.root; done

expected
--->for M in $(cat masses.txt); do bash make_PLC.sh --PE $M comb_hzz4l.root; done

To get the robust estimate, use -s -P (note that -P -s does not work, the bash script is not smart enough)
The output files will be called PLP instead of PLC.

You can edit make_PLC.sh to make --PE do expected significance instead of just p-value.


################ Running Asymptotic CLS ##################

---> for M in $(cat masses.txt); do bash make_ASCLS.sh -l $M comb_hzz4l.root; done

This will create in each mass directory a root file with the limit and a log file called e.g. comb.log.PLC. You can find below how to harvest these files 
and make plots

If you get bad fits for some masses, you can repeat the limit in a more robust way repeating the fit multiple times (but it's much slower, so you probably
don't want to do it for all masses)

--->for M in $(cat masses.txt); do bash make_ASCLS.sh -s $M comb_hzz4l.root; done

To produce _p_-value scans 

--->for M in $(cat masses.txt); do bash make_PLC_hzz4l.sh -P $M comb_hzz4l.root; done

To get the robust estimate, use -s -P (note that -P -s does not work, the bash script is not smart enough)
The output files will be called PLP instead of PLC.


################ Running CLs limits on the grid ####################
The procedure is:
-get an estimate of the limit from ASCLS, harvest, run bands
-create a grid of test statistic distributions around that value
-use the grid to compute observed and expected limits

--->./harvest.sh -v ASCLS hzz4l

--->root -b -l -q makeBands.cxx

--->root -l -b -q "plots.cxx(0)"

--->chmod -w grids/hzz4l.txt

The first two points are done with the make_grid.sh script; modify it to set the number of points and toys to something reasonable for your case; a ballpark number is 10-20 points and 1k-5k toys per point. You can check how many jobs would be submitted with

--->bash make_grid_new.sh --pri $M comb_hzz4l.root

and then submit them with

--->for M in $(cat masses_NUMBER.txt); do bash make_grid_new.sh --go --pri $M comb_hzz4l.root; done

Some suggestions:
If you're submitting directly to the grid and not to some faster batch queue, split the masses.txt file in multiple sub-files because otherwise it will 
take hours to submit all jobs

You can use the script watch_grid.sh to monitor your grid jobs: takes as argument one mass, it will check all crab sub-directories under that mass 
directory and submit/getoutput/resubmit jobs if necessary.

You can re-send more jobs making another crab task, e.g. bash make_grid.sh --go -2 $M comb.root will create task directory crab_0_comb_wide.2 and so on 
(from -2 up to -7)

If you get a wrong grid for a given point, you can force the grid endpoints manually with; e.g. to make a grid in the 0.05-1.0 interval for m(H) = 325 GeV
do 
--->bash make_grid.sh -F 0.5:1 325 comb.root

If your observed limit turns out to be far from the expected one, when re-making more points you can submit them centered on the CLS expected limit using 
--->bash make_grid.sh --exp $M comb.root.

For the second part, there is the make_FREQ.sh script, which works similarly to the make_PLC.sh (but it's much slower, so again we suggest to split the 
mass.txt in several subfiles and run them in parallel)



#### Harvesting Results ####
Check and retreive output
--->for M in $(cat masses_NUMBER.txt); do bash watch_grid.sh $M; done


Run all limits
--->for M in $(cat masses_NUMBER.txt); do bash make_FREQ.sh $M comb_hzz4l.root; done

Harvest: to harvest the results for method PLC and combined workspace for all masses for which it was run, do

--->./harvest.sh PLC hzz4l
--->./harvest.sh PLP hzz4l
--->./harvest.sh PLPE hzz4l

You can replace PLC with PLP, FREQ, SMCLS or BAYES. You can replace comb with hgg, hww, htt, hzz4l, hzz2l2q hzz2l2nu.
Bands: 

Customise the makeBands.cxx script to read the bands that you want. Pay attention to keep the global variable use_precomputed_quantiles to true for CLS 
stuff and to false otherwise. Run it with

--->root.exe -b -l -q $CMSSW_BASE/src/HiggsAnalysis/CombinedLimit/test/plotting/bandUtils.cxx+ makeBands_hzz4l.cxx

Customize the ==plots.cxx== file, create a =plots= directory (or symlink to a directory somewhere else) and do

--->root.exe -b -l -q $CMSSW_BASE/src/HiggsAnalysis/CombinedLimit/test/plotting/bandUtils.cxx+ plots.cxx



See 
https://twiki.cern.ch/twiki/bin/viewauth/CMS/HiggsCombinationPreApproval,
https://twiki.cern.ch/twiki/bin/viewauth/CMS/HiggsCombinationInstructions
for more help
May you always have high limits and low p-values! :-)



####################### STREAMLINING #######################

--->./makeCardsWorkspaces.sh <massfile> <sqrts>

--->./make_parallel_limit.sh <type> <massfile> <options>

type = ASCLS, PLP, PLPE, ML
options = <nothing>-default, -s for strict


######################### PVALUES ###################
To produce _p_-value scans 

--->for M in $(cat masses.txt); do bash make_PLC.sh -P $M comb_hzz4l.root; done

To get the robust estimate, use -s -P (note that -P -s does not work, the bash script is not smart enough)
The output files will be called PLP instead of PLC.



###################### LandS ########################

Observed Asym.

./lands.exe -L $CMSSW_BASE/lib/slc5_amd64_gcc434/libHiggsAnalysisCombinedLimit.so --bMultiSigProcShareSamePDF  --minuitSTRATEGY 2  -M Asymptotic --maximumFunctionCallsInAFit 50000  -rMin 0 -rMax 100 -m $M -d cards.txt

Expected Asym.

./lands.exe -L $CMSSW_BASE/lib/slc5_amd64_gcc434/libHiggsAnalysisCombinedLimit.so --bMultiSigProcShareSamePDF  --minuitSTRATEGY 2  --PLalgorithm Migrad -M Asymptotic -D asimov_b  --maximumFunctionCallsInAFit 50000 -m $M -d cards*.txt






